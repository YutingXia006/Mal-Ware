package malware.server.uiServer;

import javafx.collections.ObservableList;
import javafx.geometry.Insets;
import javafx.geometry.Pos;
import javafx.scene.Scene;
import javafx.scene.control.Button;
import javafx.scene.control.Label;
import javafx.scene.control.ListView;
import javafx.scene.control.TextField;
import javafx.scene.image.Image;
import javafx.scene.image.ImageView;
import javafx.scene.layout.BorderPane;
import javafx.scene.layout.HBox;
import javafx.scene.layout.VBox;
import javafx.scene.paint.Color;
import javafx.scene.text.Font;
import javafx.scene.text.Text;
import javafx.stage.Screen;
import javafx.stage.Stage;
import malware.server.Server;

import java.io.FileInputStream;
import java.io.FileNotFoundException;
import java.util.ArrayList;

public class ServerUiBuilder {
    ServerActionHandler serverActionHandler;
    Stage primaryStage;
    Font font = new Font(16.0);

    public ServerUiBuilder(ServerActionHandler serverActionHandler, Stage primaryStage) {
        this.serverActionHandler = serverActionHandler;
        this.primaryStage = primaryStage;
    }

    public Scene makeServerUI() throws FileNotFoundException {
        //root
        BorderPane rootPane = new BorderPane();
        rootPane.setPrefSize(600, 350);
        rootPane.setStyle("-fx-background-color: #eeeeee");

        //banner
        HBox banner = new HBox();
        banner.setPrefHeight(100);
        banner.setStyle("-fx-background-color: dddddd;");
        banner.setPadding(new Insets(10, 0, 0, 10));
/*
        ImageView logo = new ImageView(new Image(new FileInputStream("src/main/resources/malware_logo.JPG")));
        logo.setFitWidth(80);
        logo.setPreserveRatio(true);
        banner.getChildren().add(logo);
        */

        Label bannerLabel = new Label("Start a new session...");
        bannerLabel.setFont(new Font(20));
        bannerLabel.setPadding(new Insets(30.0));
        banner.getChildren().add(bannerLabel);

        rootPane.setTop(banner);

        //main elements
        TextField portNumberTextField = new TextField();
        portNumberTextField.setPrefWidth(200.0);
        portNumberTextField.setFont(font);

        Label portNumberLabel = new Label("Port number");
        portNumberLabel.setPrefWidth(100);
        portNumberLabel.setFont(font);
        portNumberLabel.setPadding(new Insets(0, 0, 0, 10));

        Button submitButton = new Button("Done");
        submitButton.setPrefSize(100, 40);

        Label errorLabel = new Label();
        errorLabel.setTextFill(Color.color(1, 0, 0));
        errorLabel.setWrapText(true);

        //main layout
        VBox mainBox = new VBox();
        mainBox.setPadding(new Insets(20, 100, 20, 100));

        ArrayList<HBox> hBoxes = new ArrayList<>();
        HBox hBox1 = new HBox();
        HBox hBox2 = new HBox();
        HBox hBox3 = new HBox();
        hBoxes.add(hBox1);
        hBoxes.add(hBox2);
        hBoxes.add(hBox3);
        for(HBox hBox : hBoxes) {
            hBox.setAlignment(Pos.CENTER);
            hBox.setPrefHeight(100);
        }
        hBox1.setPrefHeight(60);
        mainBox.getChildren().addAll(hBox1, hBox2, hBox3);

        hBox1.getChildren().add(errorLabel);
        hBox2.getChildren().addAll(portNumberTextField, portNumberLabel);
        hBox3.getChildren().add(submitButton);

        //submit button
        submitButton.setOnAction(Event -> {
            Server server;
            server = serverActionHandler.submitServerInfo(Integer.parseInt(portNumberTextField.getText()), errorLabel);

            if(server != null) {
                primaryStage.hide();
                primaryStage.setScene(makeServerLogUI(server));
                double screenWidth = Screen.getPrimary().getBounds().getWidth();
                double screenHeight = Screen.getPrimary().getBounds().getHeight();
                primaryStage.setX(screenWidth/100);
                primaryStage.setY(screenHeight/2-primaryStage.getHeight());
                primaryStage.setAlwaysOnTop(false);
                primaryStage.show();
            }
        });

        rootPane.setCenter(mainBox);

        //return scene
        return new Scene(rootPane);
    }

    public Scene makeServerLogUI(Server server){
        //root
        BorderPane rootPane = new BorderPane();
        rootPane.setPrefSize(500, 500);
        rootPane.setStyle("-fx-background-color: #eeeeee");
        VBox left = new VBox();
        left.setSpacing(10);
        VBox right = new VBox();
        right.setSpacing(10);
        rootPane.setLeft(left);
        rootPane.setRight(right);

        HBox header = new HBox();
        header.setPrefHeight(40.0);
        header.setStyle("-fx-background-color: #dddddd");
        Label label = new Label("Keep track of your session...");
        header.getChildren().add(label);
        header.setPadding(new Insets(12, 0, 0, 20));
        rootPane.setTop(header);

        //server log ListView
        Label logLabel = new Label("Server Log");
        ListView<String> logView = new ListView<String>();
        ObservableList<String> logList = server.getServerLog();
        logView.setItems(logList);

        left.getChildren().add(logLabel);
        left.getChildren().add(logView);
        left.setPadding(new Insets(12));

        //client list ListView
        Label clientLabel = new Label("Clients Connected");
        ListView<String> clientView = new ListView<String>();
        ObservableList<String> clientList = server.clientNames;
        clientView.setItems(clientList);

        right.getChildren().add(clientLabel);
        right.getChildren().add(clientView);
        right.setPadding(new Insets(12));

        //return scene
        return new Scene(rootPane);
    }
}
