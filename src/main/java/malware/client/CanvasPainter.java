package malware.client;

import javafx.scene.canvas.Canvas;
import javafx.scene.canvas.GraphicsContext;
import javafx.scene.paint.Paint;
import malware.UserAction;
import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;

public class CanvasPainter {

    GraphicsContext gc;
    InstructionFactory instructionFactory;
    ClientNetInterface clientNetInterface;
    private static final Logger log = LogManager.getLogger(CanvasPainter.class);
    String drawingString;
    boolean pathClosed = true;


    public CanvasPainter(GraphicsContext gc, ClientNetInterface clientNetInterface) {

        this.gc = gc;
        this.clientNetInterface = clientNetInterface;
        instructionFactory = new InstructionFactory();
    }


    public void applyAction(UserAction action, double x, double y, boolean sendToServer) {

        if (action == UserAction.BUTTON_CLEAR) {

            clearCanvas(sendToServer);

        } else if (action == UserAction.BUTTON_UNDO) {

            undo();

        } else {
            if (UserAction.PRESS == action || pathClosed) {
                gc.beginPath();
                pathClosed = false;
                log.info("Painter: begin path");
            }

            gc.lineTo(x, y);
            log.info("Painter: line to " + x + " | " + y);


            gc.stroke();

            if (UserAction.RELEASE == action) {
                gc.closePath();
                pathClosed = true;
                log.info("Painter: closed path");

            }

            if (sendToServer) {
                drawToServer(action, x, y);
            }

        }


    }

    private void drawToServer(UserAction action, double x, double y) {
        drawingString = instructionFactory.createInstruction(
                clientNetInterface.getName(),
                action.toString(),
                gc.getStroke().toString(),
                String.valueOf(gc.getLineWidth()),
                x,
                y);

        clientNetInterface.writeToServer(drawingString);
    }

    public void applyServerInstruction(int instructionIndex, boolean ignoreRedraw) {


        if (clientNetInterface.getPaintLog().size() > 0) {


            String message = clientNetInterface.getPaintLog().get(instructionIndex);
            String[] completeInstruction = message.split(":");

            boolean serverForced = message.endsWith(":1") ? true : false;

            ignoreRedraw = serverForced ? true : ignoreRedraw;

            Paint rememberClientColor = gc.getStroke();
            double rememberClientWidth = gc.getLineWidth();


            // 0 clientName : 1 action : 2 color : 3 lineWidth : 4 x,y (: 5 serverForced)
            if ((!clientNetInterface.getName().equals(completeInstruction[0])) || ignoreRedraw) {
                String instructionName = completeInstruction[1];
                String strokeColor = completeInstruction[2];
                String lineWidth = completeInstruction[3];
                gc.setStroke(Paint.valueOf(strokeColor));
                gc.setLineWidth(Double.parseDouble(lineWidth));
                String[] coords = completeInstruction[4].split(",");
                float x = Float.parseFloat(coords[0]);
                float y = Float.parseFloat(coords[1]);


                UserAction instructedAction = UserAction.getUserAction(instructionName);


                log.warn("Drawing from PaintLog:" + message);
                applyAction(instructedAction, x, y, false);
            }

            gc.setStroke(rememberClientColor);
            gc.setLineWidth(rememberClientWidth);
        }

    }

    public void clearCanvas(boolean sendToServer) {
        gc.clearRect(0, 0, gc.getCanvas().getWidth(), gc.getCanvas().getHeight());

        if (sendToServer) {
            clientNetInterface.writeToServer(
                    instructionFactory.createInstructionShort(
                            clientNetInterface.getName(),
                            UserAction.BUTTON_CLEAR
                    )
            );
        }


        clientNetInterface.clearPaintLog();
    }

    private void redraw() {
        log.warn("Redrawing");
        Canvas c = gc.getCanvas();
        gc.clearRect(0, 0, c.getWidth(), c.getHeight());
        for (int i = 0; i <= clientNetInterface.getPaintLog().size() - 1; i++) {
            applyServerInstruction(i, true);
        }
    }

    private void undo() {


        clientNetInterface.writeToServer(
                instructionFactory.createInstructionShort(
                        clientNetInterface.getName(),
                        UserAction.BUTTON_UNDO
                )
        );


    }


}
